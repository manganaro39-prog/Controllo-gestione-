<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard Controllo Gestione</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body { font-family: Arial; margin: 24px; }
h1 { margin-bottom: 10px; }
.card {
border:1px solid #ddd;
border-radius:10px;
padding:15px;
margin:10px 0;
display:inline-block;
min-width:200px;
}
table {
width:100%;
border-collapse: collapse;
margin-top:20px;
}
th, td {
border-bottom:1px solid #eee;
padding:8px;
}
th { background:#f5f5f5; }
</style>
</head>

<body>

<h1>Dashboard Controllo Gestione</h1>

<input type="file" id="pdfFile" accept=".pdf">

<div class="card">
Totale incasso
<div id="totale">0 €</div>
</div>

<div class="card">
Totale pezzi
<div id="pezzi">0</div>
</div>

<table>
<thead>
<tr>
<th>Prodotto</th>
<th>Quantità</th>
<th>Totale</th>
</tr>
</thead>
<tbody id="tabella"></tbody>
</table>

<script>

pdfjsLib.GlobalWorkerOptions.workerSrc =
'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

document.getElementById('pdfFile').addEventListener('change', async function(e){

const file = e.target.files[0];
const reader = new FileReader();

reader.onload = async function(){

const pdf = await pdfjsLib.getDocument(reader.result).promise;

let totaleIncasso = 0;
let totalePezzi = 0;
let prodotti = {};

for(let p=1; p<=pdf.numPages; p++){

const page = await pdf.getPage(p);
const content = await page.getTextContent();

const text = content.items.map(i => i.str).join(" ");

const regex = /([A-Z0-9 \/]+)\s+(\d+)\s+€([\d\.,]+)/g;

let match;

while(match = regex.exec(text)){

let nome = match[1].trim();
let qty = parseInt(match[2]);
let totale = parseFloat(match[3].replace(",", "."));

if(!prodotti[nome]) prodotti[nome] = {qty:0, tot:0};

prodotti[nome].qty += qty;
prodotti[nome].tot += totale;

totalePezzi += qty;
totaleIncasso += totale;

}

}

document.getElementById("totale").innerText =
totaleIncasso.toFixed(2) + " €";

document.getElementById("pezzi").innerText =
totalePezzi;

let html = "";

for(let nome in prodotti){

html += `
<tr>
<td>${nome}</td>
<td>${prodotti[nome].qty}</td>
<td>${prodotti[nome].tot.toFixed(2)} €</td>
</tr>
`;

}

document.getElementById("tabella").innerHTML = html;

};

reader.readAsArrayBuffer(file);

});

</script>

</body>
</html>
